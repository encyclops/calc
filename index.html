<html>

<head>
    <h1>Kalkulator</h1>
</head>

<body>
    <table id="calTable" style="border: 1px solid;">
        <thead id="calTHead">
            <tr>
                <th>Jenis Makanan</th>
                <th>Jumlah dalam gram</th>
                <th>
                    <button id="addButton" onclick="addRow()" type="button">+</button>
                </th>
            </tr>
        </thead>
        <tbody id="calTBody">
            <tr>
                <td>
                    <select name="typeSelect1" id="typeSelect1">
                    </select>
                </td>
                <td>
                    <input type="number" id="amountInput1" name="amountInput1" min="1">
                </td>
            </tr>
        </tbody>
    </table>
    <div id="radioContainer">
    </div>
    <button id="calculateBtn" onclick="calculate()" type="button">Calculate</button>
    <input id="result" style="display: none;" readonly>
</body>
<script>
    let rowCounter = 1;

    function addRow() {
        rowCounter++;

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
        <td>
            <select name="typeSelect${rowCounter}" id="typeSelect${rowCounter}"></select>
        </td>
        <td>
            <input type="number" id="amountInput${rowCounter}" name="amountInput${rowCounter}" min="1">
        </td>
        <td>
            <button onclick="deleteRow(this)" type="button">-</button>
        </td>
    `;

        document.getElementById('calTBody').appendChild(newRow);
        populateOptions(rowCounter);
    }

    function deleteRow(button) {
        const row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    async function calculate() {
        const radioButtons = document.querySelectorAll('input[type="radio"][name="rPattern"]');
        let checked = false;

        radioButtons.forEach(radioButton => {
            if (radioButton.checked) {
                checked = true;
            }
        });

        if (checked) {
            const inputElements = document.querySelectorAll('[id^="amountInput"]');
            let empty = false;

            inputElements.forEach(inputElement => {
                if (inputElement.value == '') {
                    empty = true;
                }
            });

            if (!empty) {
                const selectElements = document.querySelectorAll('[id^="typeSelect"]');
                const promises = [];

                selectElements.forEach(select => {
                    promises.push(getFoodType(select.value));
                });

                try {
                    const results = await Promise.all(promises);
                    let i = 1;
                    let totalPro = 0;
                    let totalLys = 0;
                    let totalSAA = 0;
                    let totalThr = 0;
                    let totalTrp = 0;

                    results.forEach(data => {
                        if (!document.getElementById('amountInput' + i)) i++;
                        const input = parseFloat(document.getElementById('amountInput' + i).value) / 100;

                        const pro = input * data['FTYPE_PROTEIN'];
                        totalPro += pro;
                        
                        const lys = pro * data['FTYPE_COMPLYS'] * data['FTYPE_TRUELYS'];
                        totalLys += lys;

                        const saa = pro * data['FTYPE_COMPSAA'] * data['FTYPE_TRUESAA'];
                        totalSAA += saa;
                        
                        const thr = pro * data['FTYPE_COMPTHR'] * data['FTYPE_TRUETHR'];
                        totalThr += thr;

                        const trp = pro * data['FTYPE_COMPTRP'] * data['FTYPE_TRUETRP'];
                        totalTrp += trp;
                        i++;
                    });

                    const aaLys = totalLys / totalPro;
                    const aaSAA = totalSAA / totalPro;
                    const aaThr = totalThr / totalPro;
                    const aaTrp = totalTrp / totalPro;
                    
                    const refPatternRBtn = document.querySelector('input[type="radio"][name="rPattern"]:checked');
                    if (refPatternRBtn) {
                        const data = await getRefPattern(refPatternRBtn.value);

                        const rRatioLys = aaLys / data['RPATT_LYS'];
                        const rRatioSAA = aaSAA / data['RPATT_SAA'];
                        const rRatioThr = aaThr / data['RPATT_THR'];
                        const rRatioTrp = aaTrp / data['RPATT_TRP'];

                        var lowestRatio = Math.round(Math.min(rRatioLys, rRatioSAA, rRatioThr, rRatioTrp) * 100);

                        if (lowestRatio < 75) lowestRatio += " (buruk)";
                        else if (lowestRatio < 100) lowestRatio += " (baik)";
                        else lowestRatio += " (sangat baik)";

                        document.getElementById('result').value = lowestRatio;
                        document.getElementById('result').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error fetching options:', error);
                }
            } else {
                console.log('Please fill all empty input.');
            }
        } else {
            console.log('Please select an option before calculating.');
        }
    }

    async function populateOptions(rowNumber) {
        try {
            const requestBody = new FormData();
            requestBody.append('action', 'allFoodType');

            const response = await fetch('populate_options.php', {
                method: 'POST',
                body: requestBody
            });

            if (response.ok) {
                const data = await response.text();
                const select = document.getElementById(`typeSelect${rowNumber}`);
                select.innerHTML = data;
            } else {
                console.error('Error:', response.statusText);
            }
        } catch (error) {
            console.error('Error fetching options:', error);
        }
    }

    async function getFoodType(rowNumber) {
        try {
            const requestBody = new FormData();
            requestBody.append('action', 'oneFT');
            requestBody.append('FTYPE_ID', rowNumber);

            const response = await fetch('populate_options.php', {
                method: 'POST',
                body: requestBody
            });

            if (response.ok) {
                const data = await response.text();
                const dataArray = JSON.parse(data);
                return dataArray;
            } else {
                console.error('Error:', response.statusText);
            }
        } catch (error) {
            console.error('Error fetching options:', error);
        }
    }

    async function getRefPattern(id) {
        try {
            const requestBody = new FormData();
            requestBody.append('action', 'oneRP');
            requestBody.append('RPATT_ID', id);

            const response = await fetch('populate_options.php', {
                method: 'POST',
                body: requestBody
            });

            if (response.ok) {
                const data = await response.text();
                const dataArray = JSON.parse(data);
                return dataArray;
            } else {
                console.error('Error:', response.statusText);
            }
        } catch (error) {
            console.error('Error fetching options:', error);
        }
    }

    async function fetchData() {
        try {
            const requestBody = new FormData();
            requestBody.append('action', 'allRefPattern');

            const response = await fetch('populate_options.php', {
                method: 'POST',
                body: requestBody
            });

            if (response.ok) {
                const data = await response.text();
                const container = document.getElementById(`radioContainer`);
                container.innerHTML = data;
            } else {
                console.error('Error:', response.statusText);
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            return [];
        }
    }

    fetchData();
    populateOptions(1);
</script>

</html>